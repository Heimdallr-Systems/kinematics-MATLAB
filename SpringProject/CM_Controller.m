function [Theta1d, Theta2d, Theta3d] = CM_Controller(Theta, r_II_cm, r_II_cm_d, r_II_B_0, T_I_B_0, legs_on_gnd)

Theta1_FR = Theta(1);
Theta1_FL = Theta(2);
Theta1_BR = Theta(3);
Theta1_BL = Theta(4);
Theta2_FR = Theta(5);
Theta2_FL = Theta(6);
Theta2_BR = Theta(7);
Theta2_BL = Theta(8);
Theta3_FR = Theta(9);
Theta3_FL = Theta(10);
Theta3_BR = Theta(11);
Theta3_BL = Theta(12);

Theta1_0 = [Theta1_FR;Theta1_FL;Theta1_BR;Theta1_BL];
Theta2_0 = [Theta2_FR;Theta2_FL;Theta2_BR;Theta2_BL];
Theta3_0 = [Theta3_FR;Theta3_FL;Theta3_BR;Theta3_BL];

% Find C position (assumes no slipping or movement of C)
[r_II_c_FR,r_II_c_FL,r_II_c_BR,r_II_c_BL] = CPos_wrt_I(Theta1_0, Theta2_0, Theta3_0, T_I_B_0, r_II_B_0);
r_II_c = [r_II_c_FR,r_II_c_FL,r_II_c_BR,r_II_c_BL];

error = 1;
while error > 0.04
d_Rcm = [ (158979741669372749733066978379063*cos(Theta1_FR))/38909738785192413116683761221632000 + (15570750395702335*cos(Theta1_FR)^2*cos(Theta2_FR))/1105881289765659776 - (15570750395702335*cos(Theta2_FR)*sin(Theta1_FR)^2)/1105881289765659776 - (4372016150985706923176338881103*cos(Theta1_FR)^2*sin(Theta2_FR))/637497160256592496503746743855218688 + (4372016150985706923176338881103*sin(Theta1_FR)^2*sin(Theta2_FR))/637497160256592496503746743855218688 + (9421071482335975200864871983513*cos(Theta1_FR)*sin(Theta1_FR))/2490223282252314439467760718184448 + (57324412161141119794540447421463*cos(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR)^3*cos(Theta2_FR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*sin(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*sin(Theta1_FR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*sin(Theta2_FR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*cos(Theta2_FR)*sin(Theta1_FR)^2)/4980446564504628878935521436368896, (15570750395702335*cos(Theta2_FL)*sin(Theta1_FL)^2)/1105881289765659776 - (15570750395702335*cos(Theta1_FL)^2*cos(Theta2_FL))/1105881289765659776 - (158979741669372749733066978379063*cos(Theta1_FL))/38909738785192413116683761221632000 - (4372016150985706923176338881103*cos(Theta1_FL)^2*sin(Theta2_FL))/637497160256592496503746743855218688 + (4372016150985706923176338881103*sin(Theta1_FL)^2*sin(Theta2_FL))/637497160256592496503746743855218688 + (9421071482335975200864871983513*cos(Theta1_FL)*sin(Theta1_FL))/2490223282252314439467760718184448 - (57324412161141119794540447421463*cos(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL)^3*cos(Theta2_FL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*sin(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*sin(Theta1_FL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*sin(Theta2_FL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*cos(Theta2_FL)*sin(Theta1_FL)^2)/4980446564504628878935521436368896, (158979741669372749733066978379063*cos(Theta1_BR))/38909738785192413116683761221632000 + (15570750395702335*cos(Theta1_BR)^2*cos(Theta2_BR))/1105881289765659776 - (15570750395702335*cos(Theta2_BR)*sin(Theta1_BR)^2)/1105881289765659776 - (4372016150985706923176338881103*cos(Theta1_BR)^2*sin(Theta2_BR))/637497160256592496503746743855218688 + (4372016150985706923176338881103*sin(Theta1_BR)^2*sin(Theta2_BR))/637497160256592496503746743855218688 - (9421071482335975200864871983513*cos(Theta1_BR)*sin(Theta1_BR))/2490223282252314439467760718184448 + (57324412161141119794540447421463*cos(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR)^3*cos(Theta2_BR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*sin(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*sin(Theta1_BR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*sin(Theta2_BR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*cos(Theta2_BR)*sin(Theta1_BR)^2)/4980446564504628878935521436368896, (15570750395702335*cos(Theta2_BL)*sin(Theta1_BL)^2)/1105881289765659776 - (15570750395702335*cos(Theta1_BL)^2*cos(Theta2_BL))/1105881289765659776 - (158979741669372749733066978379063*cos(Theta1_BL))/38909738785192413116683761221632000 - (4372016150985706923176338881103*cos(Theta1_BL)^2*sin(Theta2_BL))/637497160256592496503746743855218688 + (4372016150985706923176338881103*sin(Theta1_BL)^2*sin(Theta2_BL))/637497160256592496503746743855218688 - (9421071482335975200864871983513*cos(Theta1_BL)*sin(Theta1_BL))/2490223282252314439467760718184448 - (57324412161141119794540447421463*cos(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL)^3*cos(Theta2_BL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*sin(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*sin(Theta1_BL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*sin(Theta2_BL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*cos(Theta2_BL)*sin(Theta1_BL)^2)/4980446564504628878935521436368896,                                                                                                                                                           - (4372016150985706923176338881103*cos(Theta1_FR)*cos(Theta2_FR)*sin(Theta1_FR))/637497160256592496503746743855218688 - (15570750395702335*cos(Theta1_FR)*sin(Theta1_FR)*sin(Theta2_FR))/1105881289765659776 - (57324412161141119794540447421463*cos(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*sin(Theta1_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*sin(Theta2_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*cos(Theta2_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR)^2*sin(Theta1_FR)*sin(Theta2_FR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*sin(Theta2_FR + Theta3_FR)*cos(Theta1_FR)^2*cos(Theta2_FR)*sin(Theta1_FR))/9960893129009257757871042872737792,                                                                                                                                                             (15570750395702335*cos(Theta1_FL)*sin(Theta1_FL)*sin(Theta2_FL))/1105881289765659776 - (4372016150985706923176338881103*cos(Theta1_FL)*cos(Theta2_FL)*sin(Theta1_FL))/637497160256592496503746743855218688 + (57324412161141119794540447421463*cos(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*sin(Theta1_FL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*sin(Theta2_FL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*cos(Theta2_FL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL)^2*sin(Theta1_FL)*sin(Theta2_FL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*sin(Theta2_FL + Theta3_FL)*cos(Theta1_FL)^2*cos(Theta2_FL)*sin(Theta1_FL))/9960893129009257757871042872737792,                                                                                                                                                           - (4372016150985706923176338881103*cos(Theta1_BR)*cos(Theta2_BR)*sin(Theta1_BR))/637497160256592496503746743855218688 - (15570750395702335*cos(Theta1_BR)*sin(Theta1_BR)*sin(Theta2_BR))/1105881289765659776 - (57324412161141119794540447421463*cos(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*sin(Theta1_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*sin(Theta2_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*cos(Theta2_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR)^2*sin(Theta1_BR)*sin(Theta2_BR))/9960893129009257757871042872737792 - (57324412161141119794540447421463*sin(Theta2_BR + Theta3_BR)*cos(Theta1_BR)^2*cos(Theta2_BR)*sin(Theta1_BR))/9960893129009257757871042872737792,                                                                                                                                                             (15570750395702335*cos(Theta1_BL)*sin(Theta1_BL)*sin(Theta2_BL))/1105881289765659776 - (4372016150985706923176338881103*cos(Theta1_BL)*cos(Theta2_BL)*sin(Theta1_BL))/637497160256592496503746743855218688 + (57324412161141119794540447421463*cos(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*sin(Theta1_BL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*sin(Theta2_BL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*cos(Theta2_BL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL)^2*sin(Theta1_BL)*sin(Theta2_BL))/9960893129009257757871042872737792 + (57324412161141119794540447421463*sin(Theta2_BL + Theta3_BL)*cos(Theta1_BL)^2*cos(Theta2_BL)*sin(Theta1_BL))/9960893129009257757871042872737792, - (57324412161141119794540447421463*cos(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*sin(Theta1_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*sin(Theta2_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(Theta2_FR + Theta3_FR)*cos(Theta1_FR)^2*cos(Theta2_FR)*sin(Theta1_FR))/9960893129009257757871042872737792, (57324412161141119794540447421463*cos(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*sin(Theta1_FL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*sin(Theta2_FL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(Theta2_FL + Theta3_FL)*cos(Theta1_FL)^2*cos(Theta2_FL)*sin(Theta1_FL))/9960893129009257757871042872737792, - (57324412161141119794540447421463*cos(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*sin(Theta1_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*sin(Theta2_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(Theta2_BR + Theta3_BR)*cos(Theta1_BR)^2*cos(Theta2_BR)*sin(Theta1_BR))/9960893129009257757871042872737792, (57324412161141119794540447421463*cos(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*sin(Theta1_BL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*sin(Theta2_BL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(Theta2_BL + Theta3_BL)*cos(Theta1_BL)^2*cos(Theta2_BL)*sin(Theta1_BL))/9960893129009257757871042872737792
                   (158979741669372749733066978379063*sin(Theta1_FR))/38909738785192413116683761221632000 - (9421071482335975200864871983513*cos(2*Theta1_FR))/4980446564504628878935521436368896 - (57324412161141119794540447421463*cos(Theta2_FR + Theta3_FR)*sin(Theta1_FR)^3)/9960893129009257757871042872737792 + (15570750395702335*cos(Theta1_FR)*cos(Theta2_FR)*sin(Theta1_FR))/552940644882829888 - (4372016150985706923176338881103*cos(Theta1_FR)*sin(Theta1_FR)*sin(Theta2_FR))/318748580128296248251873371927609344 + (57324412161141119794540447421463*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR)^2*sin(Theta1_FR))/4980446564504628878935521436368896 - (57324412161141119794540447421463*sin(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*sin(Theta2_FR))/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*cos(Theta2_FR)*sin(Theta1_FR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*cos(Theta2_FR))/9960893129009257757871042872737792,                                                                                                                                                                        (57324412161141119794540447421463*cos(Theta2_FL + Theta3_FL)*sin(Theta1_FL)^3)/9960893129009257757871042872737792 - (158979741669372749733066978379063*sin(Theta1_FL))/38909738785192413116683761221632000 - (9421071482335975200864871983513*cos(2*Theta1_FL))/4980446564504628878935521436368896 - (15570750395702335*cos(Theta1_FL)*cos(Theta2_FL)*sin(Theta1_FL))/552940644882829888 - (4372016150985706923176338881103*cos(Theta1_FL)*sin(Theta1_FL)*sin(Theta2_FL))/318748580128296248251873371927609344 - (57324412161141119794540447421463*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL)^2*sin(Theta1_FL))/4980446564504628878935521436368896 + (57324412161141119794540447421463*sin(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*sin(Theta2_FL))/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*cos(Theta2_FL)*sin(Theta1_FL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*cos(Theta2_FL))/9960893129009257757871042872737792,                                                                                                                                                                        (9421071482335975200864871983513*cos(2*Theta1_BR))/4980446564504628878935521436368896 + (158979741669372749733066978379063*sin(Theta1_BR))/38909738785192413116683761221632000 - (57324412161141119794540447421463*cos(Theta2_BR + Theta3_BR)*sin(Theta1_BR)^3)/9960893129009257757871042872737792 + (15570750395702335*cos(Theta1_BR)*cos(Theta2_BR)*sin(Theta1_BR))/552940644882829888 - (4372016150985706923176338881103*cos(Theta1_BR)*sin(Theta1_BR)*sin(Theta2_BR))/318748580128296248251873371927609344 + (57324412161141119794540447421463*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR)^2*sin(Theta1_BR))/4980446564504628878935521436368896 - (57324412161141119794540447421463*sin(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*sin(Theta2_BR))/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*cos(Theta2_BR)*sin(Theta1_BR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*cos(Theta2_BR))/9960893129009257757871042872737792,                                                                                                                                                                        (9421071482335975200864871983513*cos(2*Theta1_BL))/4980446564504628878935521436368896 - (158979741669372749733066978379063*sin(Theta1_BL))/38909738785192413116683761221632000 + (57324412161141119794540447421463*cos(Theta2_BL + Theta3_BL)*sin(Theta1_BL)^3)/9960893129009257757871042872737792 - (15570750395702335*cos(Theta1_BL)*cos(Theta2_BL)*sin(Theta1_BL))/552940644882829888 - (4372016150985706923176338881103*cos(Theta1_BL)*sin(Theta1_BL)*sin(Theta2_BL))/318748580128296248251873371927609344 - (57324412161141119794540447421463*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL)^2*sin(Theta1_BL))/4980446564504628878935521436368896 + (57324412161141119794540447421463*sin(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*sin(Theta2_BL))/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*cos(Theta2_BL)*sin(Theta1_BL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*cos(Theta2_BL))/9960893129009257757871042872737792, (4372016150985706923176338881103*cos(Theta1_FR)^2*cos(Theta2_FR))/1274994320513184993007493487710437376 - (4372016150985706923176338881103*cos(Theta2_FR)*sin(Theta1_FR)^2)/1274994320513184993007493487710437376 + (15570750395702335*cos(Theta1_FR)^2*sin(Theta2_FR))/2211762579531319552 - (15570750395702335*sin(Theta1_FR)^2*sin(Theta2_FR))/2211762579531319552 + (57324412161141119794540447421463*cos(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*sin(Theta2_FR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*cos(Theta2_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*sin(Theta1_FR)^2)/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*sin(Theta2_FR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*cos(Theta2_FR))/19921786258018515515742085745475584, (4372016150985706923176338881103*cos(Theta1_FL)^2*cos(Theta2_FL))/1274994320513184993007493487710437376 - (4372016150985706923176338881103*cos(Theta2_FL)*sin(Theta1_FL)^2)/1274994320513184993007493487710437376 - (15570750395702335*cos(Theta1_FL)^2*sin(Theta2_FL))/2211762579531319552 + (15570750395702335*sin(Theta1_FL)^2*sin(Theta2_FL))/2211762579531319552 - (57324412161141119794540447421463*cos(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*sin(Theta2_FL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*cos(Theta2_FL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*sin(Theta1_FL)^2)/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*sin(Theta2_FL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*cos(Theta2_FL))/19921786258018515515742085745475584, (4372016150985706923176338881103*cos(Theta1_BR)^2*cos(Theta2_BR))/1274994320513184993007493487710437376 - (4372016150985706923176338881103*cos(Theta2_BR)*sin(Theta1_BR)^2)/1274994320513184993007493487710437376 + (15570750395702335*cos(Theta1_BR)^2*sin(Theta2_BR))/2211762579531319552 - (15570750395702335*sin(Theta1_BR)^2*sin(Theta2_BR))/2211762579531319552 + (57324412161141119794540447421463*cos(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*sin(Theta2_BR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*cos(Theta2_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*sin(Theta1_BR)^2)/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*sin(Theta2_BR))/19921786258018515515742085745475584 + (57324412161141119794540447421463*cos(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*cos(Theta2_BR))/19921786258018515515742085745475584, (4372016150985706923176338881103*cos(Theta1_BL)^2*cos(Theta2_BL))/1274994320513184993007493487710437376 - (4372016150985706923176338881103*cos(Theta2_BL)*sin(Theta1_BL)^2)/1274994320513184993007493487710437376 - (15570750395702335*cos(Theta1_BL)^2*sin(Theta2_BL))/2211762579531319552 + (15570750395702335*sin(Theta1_BL)^2*sin(Theta2_BL))/2211762579531319552 - (57324412161141119794540447421463*cos(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*sin(Theta2_BL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*cos(Theta2_BL))/19921786258018515515742085745475584 + (57324412161141119794540447421463*sin(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*sin(Theta1_BL)^2)/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*sin(Theta2_BL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*cos(Theta2_BL))/19921786258018515515742085745475584,   (57324412161141119794540447421463*cos(2*Theta1_FR)*cos(Theta2_FR + Theta3_FR)*sin(Theta2_FR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*sin(Theta1_FR)^2)/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_FR)*sin(Theta2_FR + Theta3_FR)*cos(Theta1_FR)*cos(Theta2_FR))/19921786258018515515742085745475584, (57324412161141119794540447421463*sin(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*sin(Theta1_FL)^2)/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_FL)*cos(Theta2_FL + Theta3_FL)*sin(Theta2_FL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(2*Theta1_FL)*sin(Theta2_FL + Theta3_FL)*cos(Theta1_FL)*cos(Theta2_FL))/19921786258018515515742085745475584,   (57324412161141119794540447421463*cos(2*Theta1_BR)*cos(Theta2_BR + Theta3_BR)*sin(Theta2_BR))/19921786258018515515742085745475584 - (57324412161141119794540447421463*sin(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*sin(Theta1_BR)^2)/9960893129009257757871042872737792 + (57324412161141119794540447421463*cos(2*Theta1_BR)*sin(Theta2_BR + Theta3_BR)*cos(Theta1_BR)*cos(Theta2_BR))/19921786258018515515742085745475584, (57324412161141119794540447421463*sin(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*sin(Theta1_BL)^2)/9960893129009257757871042872737792 - (57324412161141119794540447421463*cos(2*Theta1_BL)*cos(Theta2_BL + Theta3_BL)*sin(Theta2_BL))/19921786258018515515742085745475584 - (57324412161141119794540447421463*cos(2*Theta1_BL)*sin(Theta2_BL + Theta3_BL)*cos(Theta1_BL)*cos(Theta2_BL))/19921786258018515515742085745475584];
  
Thetad = Theta-d_Rcm\[r_II_cm(1)-r_II_cm_d(1);r_II_cm(2)-r_II_cm_d(2)];

Theta1_d = [Thetad(1);Thetad(2);Thetad(3);Thetad(4)];
Theta2_d = [Thetad(5);Thetad(6);Thetad(7);Thetad(8)];
Theta3_d = [Thetad(9);Thetad(10);Thetad(11);Thetad(12)];

% find new r_II_B & T_I_B
[r_BB_c_FR,r_BB_c_FL,r_BB_c_BR,r_BB_c_BL] = CPos_wrt_B(Theta1_d, Theta2_d, Theta3_d);
r_BB_c = [r_BB_c_FR,r_BB_c_FL,r_BB_c_BR,r_BB_c_BL];
[T_I_B,r_II_B] = IK_Solver_BodyRot_BodyPos(r_BB_c, r_II_c, legs_on_gnd);

% compute new rcm for error
rcm = compute_rcm(Theta,r_II_B,T_I_B);

r_II_cm_d_2(1,1) = r_II_cm_d(1);
r_II_cm_d_2(2,1) = r_II_cm_d(2);
r_II_cm_d_2(3,1) = r_II_cm(3);

error = norm(rcm - r_II_cm_d_2)

Theta1_FR = Thetad(1);
Theta1_FL = Thetad(2);
Theta1_BR = Thetad(3);
Theta1_BL = Thetad(4);
Theta2_FR = Thetad(5);
Theta2_FL = Thetad(6);
Theta2_BR = Thetad(7);
Theta2_BL = Thetad(8);
Theta3_FR = Thetad(9);
Theta3_FL = Thetad(10);
Theta3_BR = Thetad(11);
Theta3_BL = Thetad(12);

Theta = Thetad;

end

Theta1d = Thetad(1:4,1);
Theta2d = Thetad(5:8,1);
Theta3d = Thetad(9:12,1);
end